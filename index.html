<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>خبرخوان ایرانی — سیاسی، ورزشی، سینما و بیشتر</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://v1.fontapi.ir/css/Vazir" rel="stylesheet">
  <link rel="icon" href="data:,">
</head>
<body>
  <header>
    <div class="container">
      <h1>خبرخوان ایرانی</h1>
      <p>تجمع خبرهای روز از معتبرترین منابع</p>
    </div>
  </header>

  <main class="container">
    <div class="tabs" id="category-tabs">
      <!-- دکمه‌ها با جاوااسکریپت پر می‌شوند -->
    </div>

    <div class="news-grid" id="news-container">
      <div class="loading">در حال بارگذاری اخبار...</div>
    </div>
  </main>

  <!-- Modal -->
  <div id="modal-overlay" class="modal-overlay">
    <div class="modal-box">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      <div class="modal-header">
        <h2 id="modal-title"></h2>
      </div>
      <div class="modal-body">
        <div id="modal-image" class="modal-image"></div>
        <p id="modal-content" class="modal-text"></p>
        <a id="modal-link" target="_blank" rel="noopener" class="modal-read-more">مشاهده خبر کامل</a>
      </div>
    </div>
  </div>

  <script>
    const categories = {
      all: "همه اخبار",
      political: "سیاسی",
      economic: "اقتصادی",
      sport: "ورزشی",
      science: "علمی",
      cultural: "فرهنگی و هنری",
      market: "بازار",
      cinema: "سینما و هنر",
      game: "بازی و گیم",
      international: "بین‌الملل"
    };

    const sources = {
      political: [
        { name: "خبرگزاری جمهوری اسلامی", url: "https://www.irna.ir/rss/tp/1" },
        { name: "خبرآنلاین - سیاسی", url: "https://www.khabaronline.ir/rss/tp/1" }
      ],
      economic: [
        { name: "اقتصاد آنلاین", url: "https://www.eghtesadonline.com/rss" },
        { name: "ایسنا - اقتصادی", url: "https://www.isna.ir/rss/tp/33" }
      ],
      sport: [
        { name: "ورزش سه", url: "https://www.varzesh3.com/rss" },
        { name: "خبرگزاری فارس - ورزشی", url: "https://www.farsnews.ir/rss/tp/6" }
      ],
      science: [
        { name: "ایسنا - علمی", url: "https://www.isna.ir/rss/tp/60" },
        { name: "خبرگزاری دانشجو - علمی", url: "https://www.isna.ir/rss/tp/180" }
      ],
      cultural: [
        { name: "خبرگزاری مهر - فرهنگی", url: "https://www.mehrnews.com/rss/tp/4" },
        { name: "ایسنا - فرهنگی", url: "https://www.isna.ir/rss/tp/5" }
      ],
      market: [
        { name: "بورس نیوز", url: "https://www.boursenews.ir/rss" },
        { name: "کالا نیوز", url: "https://www.kalanews.ir/rss" }
      ],
      cinema: [
        { name: "تسنیم - سینما", url: "https://www.tasnimnews.com/rss/tp/14" },
        { name: "ایمنا - سینما", url: "https://www.ayandnews.ir/rss/tp/18" }
      ],
      game: [
        { name: "دیجی‌رُند", url: "https://digi-rund.ir/feed/" },
        { name: "گیمگپ", url: "https://gamegap.ir/feed/" }
      ],
      international: [
        { name: "خبرگزاری جمهوری اسلامی - بین‌الملل", url: "https://www.irna.ir/rss/tp/7" },
        { name: "خبرآنلاین - بین‌الملل", url: "https://www.khabaronline.ir/rss/tp/3" }
      ]
    };

    let allNews = [];

    // رندر دکمه‌های دسته‌بندی
    function renderTabs() {
      const tabs = document.getElementById('category-tabs');
      Object.keys(categories).forEach(cat => {
        const btn = document.createElement('button');
        btn.className = cat === 'all' ? 'tab-btn active' : 'tab-btn';
        btn.textContent = categories[cat];
        btn.dataset.cat = cat;
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderNews(cat);
        });
        tabs.appendChild(btn);
      });
    }

    // پاک‌سازی متن از HTML
    function cleanText(html) {
      if (!html) return "";
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || "";
    }

    // استخراج تصویر از توضیحات
    function extractImage(desc) {
      const match = desc.match(/<img[^>]+src=["']([^"']+)["']/);
      return match ? match[1] : "";
    }

    // بارگذاری اخبار
    async function loadNews() {
      allNews = [];
      const promises = [];

      for (const [catId, feeds] of Object.entries(sources)) {
        for (const feed of feeds) {
          promises.push(
            fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}`)
              .then(res => res.json())
              .then(data => {
                if (data.status === "ok") {
                  data.items.slice(0, 3).forEach(item => {
                    allNews.push({
                      title: cleanText(item.title),
                      desc: cleanText(item.description),
                      link: item.link,
                      image: item.thumbnail || extractImage(item.description) || '',
                      category: catId
                    });
                  });
                }
              })
              .catch(err => console.warn(`خطا در ${feed.name}:`, err))
          );
        }
      }

      await Promise.allSettled(promises);
      renderNews('all');
      document.querySelector('.loading').style.display = 'none';
    }

    // نمایش اخبار
    function renderNews(category) {
      const container = document.getElementById('news-container');
      const filtered = category === 'all' ? allNews : allNews.filter(n => n.category === category);
      
      if (filtered.length === 0) {
        container.innerHTML = `<p class="no-news">خبری در این دسته‌بندی یافت نشد.</p>`;
        return;
      }

      container.innerHTML = filtered.map(news => `
        <article class="news-card" data-news='${JSON.stringify(news).replace(/'/g, "&#39;")}'>
          ${news.image ? `<div class="news-img" style="background-image: url('${news.image}')"></div>` : ''}
          <div class="news-content">
            <span class="category-badge">${categories[news.category]}</span>
            <h3>${news.title}</h3>
            <p>${news.desc.substring(0, 130)}${news.desc.length > 130 ? "…" : ""}</p>
          </div>
        </article>
      `).join('');

      // افزودن event listener به کارت‌ها
      document.querySelectorAll('.news-card').forEach(card => {
        card.addEventListener('click', () => {
          try {
            const newsStr = card.dataset.news.replace(/&#39;/g, "'");
            const news = JSON.parse(newsStr);
            openModal(news);
          } catch (e) {
            console.error("خطا در باز کردن خبر:", e);
          }
        });
      });
    }

    // باز کردن Modal
    function openModal(news) {
      document.getElementById('modal-title').textContent = news.title;
      document.getElementById('modal-content').textContent = cleanText(news.desc);
      const imgDiv = document.getElementById('modal-image');
      if (news.image) {
        imgDiv.innerHTML = `<img src="${news.image}" alt="تصویر خبر">`;
      } else {
        imgDiv.innerHTML = "";
      }
      const linkEl = document.getElementById('modal-link');
      linkEl.href = news.link || "#";
      linkEl.style.display = news.link ? "inline-block" : "none";

      document.getElementById('modal-overlay').style.display = "flex";
      document.body.style.overflow = "hidden";
    }

    function closeModal() {
      document.getElementById('modal-overlay').style.display = "none";
      document.body.style.overflow = "auto";
    }

    // بستن با کلیک خارج از Modal
    document.getElementById('modal-overlay').addEventListener('click', (e) => {
      if (e.target === document.getElementById('modal-overlay')) {
        closeModal();
      }
    });

    // راه‌اندازی
    document.addEventListener('DOMContentLoaded', () => {
      renderTabs();
      loadNews();
    });
  </script>
</body>
</html>
